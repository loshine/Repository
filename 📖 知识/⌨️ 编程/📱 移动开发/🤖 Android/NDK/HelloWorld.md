# NDK

## 1. 新建一个类，声明 native 方法

```java
package me.loshine.jnidemo;

public class JNIUtils {

    public native String getCString();
}
```

## 2. 在 MainActivity 中使用该类

```java
public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        TextView textView = (TextView) this.findViewById(R.id.text);

        JNIUtils jni = new JNIUtils();
        textView.setText(jni.getCString());
    }
}
```

## 3. 编译 .h 头文件

build project 得到其中间文件，我们关注的是.class文件。编译 OK 以后生成的 class 文件在 AS 工程的如下目录：

`项目名/app/build/intermediates/classes/debug`
然后接下来的步骤就是根据生成的 class 文件，利用 javah 生成对应的 .h头文件。

点开 AS 的 Terminal 标签，默认进入到该项目的 app 文件夹下：

`xxxxx\app> cd build/intermediates/classes/debug`

然后执行如下 javah 命令生成 h 文件：

```bash
xxxxx\debug> javah -jni me.loshine.jnidemo.JNIUtils
```

然后就可以生成对应的`me_loshine_jnidemo_JNIUtils.h`文件了：

```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class me_loshine_jnidemo_JNIUtils */

#ifndef _Included_me_loshine_jnidemo_JNIUtils
#define _Included_me_loshine_jnidemo_JNIUtils
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     me_loshine_jnidemo_JNIUtils
 * Method:    getCString
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_me_loshine_jnidemo_JNIUtils_getCString
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```

## 3. 编写C代码

将上面生成的`me_loshine_jnidemo_JNIUtils.h`复制到`app/src/main/jni/`，然后编写一个文件

`jniutil.c`

```c
#include "me_loshine_jnidemo_JNIUtils.h"
/*
 * Class:     me_loshine_jnidemo_JNIUtils
 * Method:    getCString
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_me_loshine_jnidemo_JNIUtils_getCString
  (JNIEnv *env, jobject obj){
     return (*env)->NewStringUTF(env,"This is just a test for Android Studio NDK JNI developer!");
  }
```

## 4. 配置项目

```gradle
defaultConfig {
    ......
    ndk{
        moduleName "JniSo"         //生成的so名字
        abiFilters "armeabi", "armeabi-v7a", "x86"  //输出指定三种abi体系结构下的so库。目前可有可无。
    }
}
```

## 5. 使用

修改`JNIUtils.java`，加载 native 文件

```java
package me.loshine.jnidemo;

public class JNIUtils {

    static {
        //defaultConfig.ndk.moduleName
        System.loadLibrary("JniSo");
    }

    public native String getCString();
}
```

## 6. 运行结果

...